Function.prototype.method=function(name,func){return this.prototype[name]=func,this},Function.method("inherits",function(superCtor){return this.super_=superCtor,this.prototype=Object.create(superCtor.prototype,{constructor:{value:this,enumerable:!1,writable:!0,configurable:!0}}),this});var Events=function(){this._cbList={}};Events.method("fire",function(name,args){if(this._cbList[name])for(var i in this._cbList[name])this._cbList[name][i].apply(this,args)}),Events.method("fireLater",function(name){var that=this,args=[];return arguments.length>1&&(args=Array.prototype.slice.call(arguments,1)),function(){that.fire(name,args.concat(arguments))}}),Events.method("on",function(name,func){return this._cbList[name]||(this._cbList[name]=[]),this._cbList[name].push(func),{name:name,index:this._cbList[name].length-1}}),Events.method("off",function(id){return this._cbList[id.name].splice(id.index),this});var MBAP_TID=0,MBAP_PID=2,MBAP_LEN=4,MBAP_UID=6,BODY_FC=0,BODY_START=1,BODY_COUNT=3,READ_COILS=1,READ_INPUT_REGISTERS=4,WRITE_SINGLE_COIL=5,WRITE_SINGLE_REGISTER=6;ModbusClient=function(con){if(!(this instanceof ModbusClient))return new ModbusClient(con);Events.call(this),this.con=con,this.state="offline",this.id=0,this.handler={};var that=this;this._receiveListener=function(resp){for(var offset=0,hasMore=!0,data=resp.data;hasMore;){var mbap=new DataView(data,offset+0,7),tid=mbap.getUint16(0),pid=mbap.getUint16(2),len=mbap.getUint16(4),uid=mbap.getUint8(6),res={};res.header={transaction_id:tid,protocol_id:pid,length:len,unit_id:uid};var pdu=new DataView(data,offset+7,2);if(res.pdu={fc:pdu.getUint8(0),byte_count:pdu.getUint8(1)},that.handler[tid]){clearTimeout(that.handler[tid].timeout);var rHandler;if(res.pdu.fc>128)that.handler[tid].callback.reject(),offset+=9+res.pdu.byte_count,hasMore=offset<data.byteLength;else if(rHandler=that._responseHandler[res.pdu.fc]){var uHandler=that.handler[tid];res.pdu.data=rHandler(res,offset,data,uHandler.requestPacket),res.pdu.data?uHandler.callback.resolve(res.pdu.data,res):uHandler.callback.resolve(res),delete that.handler[tid],offset+=9+res.pdu.byte_count,hasMore=offset<data.byteLength}else{var error={errCode:"noResponseHandler",fc:res.pdu.fc};that.fire("error",[error]),that.handler[tid].callback.reject(error),offset+=9+res.pdu.byte_count,hasMore=offset<data.byteLength}}else offset+=9+res.pdu.byte_count,hasMore=offset<data.byteLength}},this._responseHandler={},this._responseHandler[1]=function(response,offset,data,request){var i,t,j,mask,dv=new DataView(data,offset+9,response.pdu.byte_count),fc_data=[],dvReq=new DataView(request,0,request.byteLength),count=dvReq.getUint16(10);for(i=0;i<response.pdu.byte_count;i+=1)for(t=dv.getUint8(i),j=0;7>j&&(mask=1<<j,fc_data.push(t&0!==mask),count-=1,0!==count);j+=1);return fc_data},this._responseHandler[4]=function(response,offset,data){for(var dv=new DataView(data,offset+9,response.pdu.byte_count),fc_data=[],i=0;i<response.pdu.byte_count/2;i+=1)fc_data.push(dv.getUint16(2*i));return fc_data},this._responseHandler[5]=function(){return null},this._responseHandler[6]=function(){return null},this._createMBAP=function(packet,id){var dv=new DataView(packet,0,7);dv.setUint16(MBAP_TID,id),dv.setUint16(MBAP_PID,0),dv.setUint16(MBAP_LEN,6),dv.setUint8(MBAP_UID,255)},this._createNewId=function(){this.id=(this.id+1)%1e4},this._sendPacket=function(packet){if(this._pQueue||(this._pQueue=[]),arguments.length>0&&this._pQueue.push(packet),!this._isWaiting&&0!==this._pQueue.length){this._isWaiting=!0;var that=this;chrome.sockets.tcp.send(this.con.socketId,this._pQueue.shift(),function(){that._isWaiting=!1,that._sendPacket()})}},this._setCallbackHandler=function(handler,packet,id){var timeout=setTimeout(function(){handler.reject({errCode:"timeout"})},1e4);this.handler[id]={callback:handler,requestPacket:packet,timeout:timeout}},this._readCoils=function(regNo,regCount){var defer=$.Deferred();this.con.socketId||defer.reject();var packet=new ArrayBuffer(12),body=new DataView(packet,7,5),id=this.id;this._createMBAP(packet,id),body.setUint8(BODY_FC,READ_COILS),body.setUint16(BODY_START,regNo),body.setUint16(BODY_COUNT,regCount);new DataView(packet,0,12);return this._setCallbackHandler(defer,packet,id),this._createNewId(),this._sendPacket(packet),defer.promise()},this._readInputRegisters=function(regNo,regCount){var defer=$.Deferred();this.con.socketId||defer.reject();var packet=new ArrayBuffer(12),body=new DataView(packet,7,5),id=this.id;return this._createMBAP(packet,id),body.setUint8(BODY_FC,READ_INPUT_REGISTERS),body.setUint16(BODY_START,regNo),body.setUint16(BODY_COUNT,regCount),this._setCallbackHandler(defer,packet,id),this._createNewId(),this._sendPacket(packet),defer.promise()},this._writeSingleCoil=function(addr,value){var defer=$.Deferred();this.con.socketId||defer.reject();var packet=new ArrayBuffer(12),body=new DataView(packet,7,5),id=this.id;return this._createMBAP(packet,id),body.setUint8(BODY_FC,WRITE_SINGLE_COIL),body.setUint16(BODY_START,addr),body.setUint16(BODY_COUNT,value?65280:0),this._setCallbackHandler(defer,packet,id),this._createNewId(),this._sendPacket(packet),defer.promise()},this._writeSingleRegister=function(regNo,value){var defer=$.Deferred();this.con.socketId||defer.reject();var packet=new ArrayBuffer(12),body=new DataView(packet,7,5),id=this.id;return this._createMBAP(packet,id),body.setUint8(BODY_FC,WRITE_SINGLE_REGISTER),body.setUint16(BODY_START,regNo),body.setUint16(BODY_COUNT,value),this._setCallbackHandler(defer,packet,id),this._createNewId(),this._sendPacket(packet),defer.promise()},chrome.sockets.tcp.onReceive.addListener(this._receiveListener)},ModbusClient.inherits(Events),ModbusClient.method("readCoils",function(regNo,regCount){if("offline"===this.status)throw new Error("Client is offline.");return this._readCoils(regNo,regCount)}),ModbusClient.method("readInputRegisters",function(regNo,regCount){if("offline"===this.status)throw new Error("Client is offline.");return this._readInputRegisters(regNo,regCount)}),ModbusClient.method("writeSingleCoil",function(regNo,value){if("offline"===this.status)throw new Error("Client is offline.");return this._writeSingleCoil(regNo,value)}),ModbusClient.method("writeSingleRegister",function(regNo,value){if("offline"===this.status)throw new Error("Client is offline.");return this._writeSingleRegister(regNo,value)}),ModbusLoop=function(client,duration){if(!(this instanceof ModbusLoop))return new ModbusLoop(client,duration);if(Events.call(this),!client)throw new Error("No Modbus client defined!");this._client=client,this._duration=duration,this._handler={},this._start=!1,this._counter=-1,this._id=0,this._exTime=1e7,this._client.on("error",function(){this.fire("error",arguments)}),this._confirmTermination=function(){if(-1!==this._counter)for(var i in this._handler)if(!this._handler[i].executed)return this.stop(),void this.fire("error",[{errCode:"loopOutOfSync"}])},this._resetExecutionFlags=function(){for(var i in this._handler)this._handler[i].executed=!1},this._callHandlers=function(){for(var i in this._handler)this._handler[i].func()};var that=this;this._duration?this.iid=setInterval(function(){that._start&&(that._confirmTermination(),that._resetExecutionFlags(),that._callHandlers(),that._counter=(that._counter+1)%1e3)},this._duration):this._freeLoop=function(){if(that._start){var start=(new Date).getTime(),cntr=that._id,allHandler=[],finishHandler=function(){if(cntr-=1,0===cntr){var end=(new Date).getTime();that._exTime=end-start;for(var j in allHandler)that.off(allHandler[j]);that._freeLoop()}};for(var i in that._handler){var h=that.on(i,finishHandler);allHandler.push(h)}that._callHandlers()}}},ModbusLoop.inherits(Events),ModbusLoop.method("readCoils",function(start,count){var that=this,id=this._id,handler=function(){that._client.readCoils(start,count).then(function(data){that._handler[id].executed=!0,that.fire(id,data)}).fail(function(){that.stop(),that.fire("error",[{errCode:id,args:arguments}])})};return this._handler[id]={},this._handler[id].func=handler,this._handler[id].executed=!1,this._id++}),ModbusLoop.method("readInputRegisters",function(start,count){var that=this,id=this._id,handler=function(){that._client.readInputRegisters(start,count).then(function(){that._handler[id].executed=!0,that.fire(id,arguments)}).fail(function(){that.stop(),that.fire("error",[{errCode:id,args:arguments}])})};return this._handler[id]={},this._handler[id].func=handler,this._handler[id].executed=!1,this._id++}),ModbusLoop.method("writeSingleCoil",function(reg,value){var that=this,id=this._id,handler=function(){that._client.writeSingleCoil(reg,value).then(function(){that._handler[id].executed=!0,that.fire(id,arguments)}).fail(function(){that.stop(),that.fire("error",[{errCode:id,args:arguments}])})};return this._handler[id]={},this._handler[id].func=handler,this._handler[id].executed=!1,this._id++}),ModbusLoop.method("writeSingleRegister",function(reg,value){var that=this,id=this._id,handler=function(){that._client.writeSingleRegister(reg,value).then(function(){that._handler[id].executed=!0,that.fire(id,arguments)}).fail(function(){that.stop(),that.fire("error",[{errCode:id,args:arguments}])})};return this._handler[id]={},this._handler[id].func=handler,this._handler[id].executed=!1,this._id++}),ModbusLoop.method("createRegister",function(cls,startReg){var reg=new cls(this._client,startReg),id=this.readInputRegisters(startReg,2);return this.on(id,function(data){reg.update_status(data[0],data[1])}),reg}),ModbusLoop.method("createMultipleRegisters",function(clsses,startReg,count){for(var id,ret=[],j=0,i=0;count>i;i+=1)ret.push(new clsses[j](this._client,startReg+4*i)),j<clsses.length-1&&(j+=1);return id=this.readInputRegisters(startReg,4*count),this.on(id,function(data){for(var k=0;count>k;k+=1)ret[k].update_status(data[4*k],data[4*k+1])}),ret}),ModbusLoop.method("remove",function(id){return this._handler[id]?(delete this._handler[id],!0):!1}),ModbusLoop.method("start",function(){this._counter=-1,this._start=!0,this._duration||this._freeLoop()}),ModbusLoop.method("stop",function(){this._start=!1});var ModbusServerClient=function(clientSocketId,server){if(!(this instanceof ModbusServerClient))return new ModbusServerClient(clientSocketId,server);this._client_socket_id=clientSocketId,this._server=server,this._get_requests=function(data){for(var header,body,request,ret=[],offset=0;offset<data.byteLength;)header=new DataView(data,offset,7),request={header:{tid:header.getUint16(0),pid:header.getUint16(2),len:header.getUint16(4),uid:header.getUint8(6)}},offset+=7,body=new DataView(data,offset,request.header.len-1),request.body={fc:body.getUint8(0)},4===request.body.fc&&(request.body.adr=body.getUint16(1),request.body.cnt=body.getUint16(3)),6===request.body.fc&&(request.body.adr=body.getUint16(1),request.body.val=body.getUint16(3)),offset+=request.header.len-1,ret.push(request);return ret},this._handle_request=function(request){var ret_buffer,ret_head_dv,ret_body_dv;if(4===request.body.fc){ret_buffer=new ArrayBuffer(9+2*request.body.cnt),ret_body_dv=new DataView(ret_buffer,7,2+2*request.body.cnt),ret_body_dv.setUint8(0,4),ret_body_dv.setUint8(1,request.body.cnt);for(var i=0;i<request.body.cnt;i+=1)ret_body_dv.setUint16(2+2*i,this._server.getInputRegister(request.body.adr+i))}return 6===request.body.fc&&(ret_buffer=new ArrayBuffer(12),ret_body_dv=new DataView(ret_buffer,7,5),this._server.setInputRegister(request.body.adr,request.body.val),this._server.fire("writeInputRegister",[request.body.adr,request.body.val]),ret_body_dv.setUint8(0,6),ret_body_dv.setUint16(1,request.body.adr),ret_body_dv.setUint16(3,request.body.val)),ret_head_dv=new DataView(ret_buffer,0,7),ret_head_dv.setUint16(0,request.header.tid),ret_head_dv.setUint16(2,request.header.pid),ret_head_dv.setUint16(4,request.header.len),ret_head_dv.setUint8(6,request.header.uid),ret_buffer},this._send_answer=function(buffer){var defer=$.Deferred();return chrome.sockets.tcp.send(this._client_socket_id,buffer,function(ret){return 0>ret?void defer.reject():void defer.resolve()}),defer.promise()},this._handle_message=function(info){for(var requests=this._get_requests(info.data),send_q=[],ret=null,i=0;i<requests.length;i+=1)ret=this._handle_request(requests[i]),send_q.push(this._send_answer(ret));$.when(send_q).then(function(){}).fail(function(){})};chrome.sockets.tcp.setPaused(this._client_socket_id,!1,function(){}),chrome.sockets.tcp.onReceive.addListener(this._handle_message.bind(this))},ServerRegister=function(start,server){return this instanceof ServerRegister?(Events.call(this),this._start=start,this._server=server,this._command={count:0,id:0,ex:!1},this._status={stateflag_1:!1,stateflag_2:!1,stateflag_3:!1,stateflag_4:!1,stateword:0,command_counter:0,command_ex:!1,command_fail:!1,arg:0},this._update_status=function(){var s=0;s+=this._status.stateflag_1?1:0,s+=this._status.stateflag_2?2:0,s+=this._status.stateflag_3?4:0,s+=this._status.stateflag_4?8:0,s+=15&this._status.stateword,s+=0&this._status.command_count,s+=this._status.command_ex?16384:0,s+=this._status.command_fail?32768:0,this._server.setInputRegister(this._start+1,this._status.arg),this._server.setInputRegister(this._start,s)},this._evaluate=function(val){this._command.count=7&val,this._command.id=262080&val,this._command.ex=val&32768<<15,this._status.command_counter=this._command.count,this._status.command_ex=!0,this._update_status()},void this._server.on("writeSingleRegister",function(start,val){start===this._start+2&&this._evaluate(val)})):new ServerRegister(start,server)};ServerRegister.inherits(Events),ModbusServer=function(host,port){return this instanceof ModbusServer?(Events.call(this),this._host=host,this._port=port,this._socket_id=null,this._is_connected=!1,this._clients=[],this._input_register_offset=0,this._input_register=[],this._coils=[],void(this._create_new_client=function(info){this._clients.push(new ModbusServerClient(info.clientSocketId,this))})):new ModbusServer(host,port)},ModbusServer.inherits(Events),ModbusServer.method("start",function(){var defer=$.Deferred(),that=this;chrome.sockets.tcpServer.create(function(createInfo){that._socket_id=createInfo.socketId,chrome.sockets.tcpServer.listen(that._socket_id,that._host,that._port,function(res){return 0>res?(defer.reject({errCode:"notListening",result:res}),void chrome.sockets.tcpServer.close(that._socket_id,function(){})):(chrome.sockets.tcpServer.onAccept.addListener(that._create_new_client.bind(that)),void defer.resolve())})})}),ModbusServer.method("stop",function(){chrome.sockets.tcpServer.close(this._socket_id,function(){})}),ModbusServer.method("setInputRegisterOffset",function(offset){return this._input_register_offset=offset,this}),ModbusServer.method("setInputRegister",function(adr,value){return this._input_register[this._input_register_offset+adr]=value,this}),ModbusServer.method("getInputRegister",function(adr){return this._input_register[this._input_register_offset+adr]}),ModbusServer.method("createNewRegister",function(start){return new ServerRegister(start,this)}),Modbus={connect:function(){var con={},defer=$.Deferred();return con.host=arguments[0],con.port=2===arguments.length?arguments[1]:502,chrome.sockets.tcp.create({},function(createInfo){con.socketId=createInfo.socketId,chrome.sockets.tcp.connect(con.socketId,con.host,con.port,function(result){return 0!==result?(defer.reject({errCode:"connectionError",result:result}),void chrome.sockets.tcp.destroy(con.socketId)):void defer.resolve(new ModbusClient(con))})}),defer.promise()},close:function(socketId){chrome.sockets.tcp.close(socketId)}},Register=function(client,start){return this instanceof Register?(Events.call(this),this.client=client,this.start=start,this.status={stateflag_1:!1,stateflag_2:!1,stateflag_3:!1,stateflag_4:!1,state:0,cmd_count:0,cmd_ex:!1,cmd_err:!1,arg:0},this._inExecution=!1,this._queue=[],this._cmd_id=0,this._execute=function(command,param){var defer=$.Deferred();return this._queue.push({deferred:defer,command:command,param:param}),this._flush(),defer.promise()},void(this._flush=function(){if(0!==this._queue.length&&!this._inExecution){this._inExecution=!0;var first=this._queue.pop(),command=first.command,defer=(first.param,first.deferred);this._cmd_id=(this._cmd_id+1)%8;var cmd=command<<3,ex_flag=32768,that=this;this.cmd_reg=this._cmd_id+cmd+ex_flag,this.client.writeSingleRegister(this.start+2,this.cmd_reg).fail(function(err){defer.reject({errCode:"modbusError"}),that._inExecution=!1,that._flush()}).then(function(){var handler_id,timeout_id,update_count=0;timeout_id=setTimeout(function(){defer.reject({errCode:"timeout",update_count:update_count}),that._inExecution=!1,that._flush()},5e3),handler_id=that.on("update_status",function(){update_count+=1,that.status.cmd_count===that._cmd_id&&that.status.cmd_ex&&(that.off(handler_id),clearTimeout(timeout_id),that.status.cmd_err?defer.reject({errCode:"plcError"}):defer.resolve(that.status.arg),that._inExecution=!1,that._flush())})})}})):new Register(client,start)},Register.inherits(Events),Register.method("update_status",function(status_reg,status_arg){var s_1=1,s_2=2,s_3=4,s_4=8,s_state=2032,s_cid=14336,s_cide=16384,s_cidf=32768;this.status.stateflag_1=(status_reg&s_1)>>0,this.status.stateflag_2=(status_reg&s_2)>>1,this.status.stateflag_3=(status_reg&s_3)>>2,this.status.stateflag_4=(status_reg&s_4)>>3,this.status.state=(status_reg&s_state)>>4,this.status.cmd_count=(status_reg&s_cid)>>11,this.status.cmd_ex=(status_reg&s_cide)>>14,this.status.cmd_err=(status_reg&s_cidf)>>15,this.status.arg=status_arg,this.fire("update_status")});