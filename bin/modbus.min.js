!function(){Function.prototype.method=function(name,func){return this.prototype[name]=func,this},Function.method("inherits",function(superCtor){return this.super_=superCtor,this.prototype=Object.create(superCtor.prototype,{constructor:{value:this,enumerable:!1,writable:!0,configurable:!0}}),this});var Events=function(){return this instanceof Events?void(this._cbList={}):new Events};Events.method("fire",function(name,args){if(this._cbList[name])for(var i in this._cbList[name])this._cbList[name][i].apply(this,args)}),Events.method("fireLater",function(name,args){return void 0===args&&(args=[]),function(){var a=args.concat(Array.prototype.slice.call(arguments,0));this.fire(name,a.length>0?a:void 0)}.bind(this)}),Events.method("on",function(name,func){return this._cbList[name]||(this._cbList[name]=[]),this._cbList[name].push(func),{name:name,index:this._cbList[name].length-1}}),Events.method("off",function(id){return this._cbList[id.name].splice(id.index),this}),StateMachine=function(initState){return this instanceof StateMachine?(Events.call(this),void(this._state=initState)):new StateMachine(initState)},StateMachine.inherits(Events),StateMachine.method("inState",function(state){return this._state===state}),StateMachine.method("getState",function(){return this._state}),StateMachine.method("setState",function(newState){var oldState=this._state;return this._state=newState,this.fire("state_changed",[oldState,newState]),this});var MBAP_TID=0,MBAP_PID=2,MBAP_LEN=4,MBAP_UID=6,BODY_FC=0,BODY_START=1,BODY_COUNT=3,READ_COILS=1,READ_HOLDING_REGISTERS=3,READ_INPUT_REGISTERS=4,WRITE_SINGLE_COIL=5,WRITE_SINGLE_REGISTER=6,ModbusRequest=function(id,length){return this instanceof ModbusRequest?(this.id=id,this.length=length,this.deferred=$.Deferred(),this.packet=new ArrayBuffer(length),this.header=new DataView(this.packet,0,7),this.timeout=null,void this.setTID(id).setPID(0).setLength(length-6).setUID(255)):new ModbusRequest(id)};ModbusRequest.method("setTID",function(id){return this.header.setUint16(MBAP_TID,id),this.id=id,this}),ModbusRequest.method("setPID",function(pid){return this.header.setUint16(MBAP_PID,pid),this.pid=pid,this}),ModbusRequest.method("setLength",function(len){return this.header.setUint16(MBAP_LEN,len),this.length=len,this}),ModbusRequest.method("setUID",function(uid){return this.header.setUint8(MBAP_UID,uid),this.uid=uid,this}),ModbusRequest.method("getPromise",function(){return this.deferred.promise()}),ModbusRequest.method("reject",function(){return this.deferred.reject.apply(null,arguments),this}),ModbusRequest.method("resolve",function(){return this.deferred.resolve.apply(null,arguments),this}),ModbusRequest.method("setTimeout",function(timeout){return this.timeout=timeout,this});var ReadCoilsRequest=function(id,start,count){return this instanceof ReadCoilsRequest?(ModbusRequest.call(this,id,12),this.start=start,this.count=count,this.body=new DataView(this.packet,7,5),this.body.setUint8(BODY_FC,READ_COILS),void this.setStart(start).setCount(count)):new ReadCoilsRequest(id,start,count)};ReadCoilsRequest.inherits(ModbusRequest),ReadCoilsRequest.method("setStart",function(start){return this.body.setUint16(BODY_START,start),this.start=start,this}),ReadCoilsRequest.method("setCount",function(count){return this.body.setUint16(BODY_COUNT,count),this.count=count,this}),ReadCoilsRequest.method("handleResponse",function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.deferred.reject({errCode:"serverError"}),!1;var i,t,j,mask,dv=new DataView(data,offset+9,byte_count),fc_data=[],count=this.count,fc_data=[];for(i=0;i<this.count;i+=1)for(t=dv.getUint8(i),j=0;7>j&&(mask=1<<j,fc_data.push(t&0!==mask),count-=1,0!==count);j+=1);return this.deferred.resolve(fc_data,this),!0});var ReadHoldingRegistersRequest=function(id,start,count){return this instanceof ReadHoldingRegistersRequest?(ModbusRequest.call(this,id,12),this.start=start,this.count=count,this.body=new DataView(this.packet,7,5),this.body.setUint8(BODY_FC,READ_HOLDING_REGISTERS),void this.setStart(start).setCount(count)):new ReadHoldingRegistersRequest(id,start,count)};ReadHoldingRegistersRequest.inherits(ModbusRequest),ReadHoldingRegistersRequest.method("setStart",function(start){return this.body.setUint16(BODY_START,start),this.start=start,this}),ReadHoldingRegistersRequest.method("setCount",function(count){return this.body.setUint16(BODY_COUNT,count),this.count=count,this}),ReadHoldingRegistersRequest.method("handleResponse",function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.deferred.reject({errCode:"serverError"}),!1;for(var dv=new DataView(data,offset+7+2,byte_count),fc_data=[],i=0;byte_count/2>i;i+=1)fc_data.push(dv.getUint16(2*i));return this.deferred.resolve(fc_data,this),!0});var ReadInputRegistersRequest=function(id,start,count){return this instanceof ReadInputRegistersRequest?(ModbusRequest.call(this,id,12),this.start=start,this.count=count,this.body=new DataView(this.packet,7,5),this.body.setUint8(BODY_FC,READ_INPUT_REGISTERS),void this.setStart(start).setCount(count)):new ReadInputRegistersRequest(id,start,count)};ReadInputRegistersRequest.inherits(ModbusRequest),ReadInputRegistersRequest.method("setStart",function(start){return this.body.setUint16(BODY_START,start),this.start=start,this}),ReadInputRegistersRequest.method("setCount",function(count){return this.body.setUint16(BODY_COUNT,count),this.count=count,this}),ReadInputRegistersRequest.method("handleResponse",function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.deferred.reject({errCode:"serverError"}),!1;for(var dv=new DataView(data,offset+7+2,byte_count),fc_data=[],i=0;byte_count/2>i;i+=1)fc_data.push(dv.getUint16(2*i));return this.deferred.resolve(fc_data,this),!0}),WriteSingleCoilRequest=function(id,address,value){return this instanceof WriteSingleCoilRequest?(ModbusRequest.call(this,id,12),this.address=address,this.value=value,this.body=new DataView(this.packet,7,5),this.body.setUint8(BODY_FC,WRITE_SINGLE_COIL),void this.setAddress(address).setValue(value)):new WriteSingleCoildRequest(id,address,value)},WriteSingleCoilRequest.inherits(ModbusRequest),WriteSingleCoilRequest.method("setAddress",function(address){return this.body.setUint16(BODY_START,address),this.address=address,this}),WriteSingleCoilRequest.method("setValue",function(value){return this.body.setUint16(BODY_COUNT,value?65280:0),this.value=value,this}),WriteSingleCoilRequest.method("handleResponse",function(data,offset){{var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0);pdu.getUint8(1)}return fc>128?(this.deferred.reject({errCode:"serverError"}),!1):(this.deferred.resolve(this),!0)}),WriteSingleRegisterRequest=function(id,address,value){return this instanceof WriteSingleRegisterRequest?(ModbusRequest.call(this,id,12),this.address=address,this.value=value,this.body=new DataView(this.packet,7,5),this.body.setUint8(BODY_FC,WRITE_SINGLE_REGISTER),void this.setAddress(address).setValue(value)):new WriteSingleRegisterRequest(id,address,value)},WriteSingleRegisterRequest.inherits(ModbusRequest),WriteSingleRegisterRequest.method("setAddress",function(address){return this.body.setUint16(BODY_START,address),this.address=address,this}),WriteSingleRegisterRequest.method("setValue",function(value){return this.body.setUint16(BODY_COUNT,value),this.value=value,this}),WriteSingleRegisterRequest.method("handleResponse",function(data,offset){{var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0);pdu.getUint8(1)}return fc>128?(this.deferred.reject({errCode:"serverError"}),!1):(this.deferred.resolve(this),!0)}),ModbusClient=function(timeout){if(!(this instanceof ModbusClient))return new ModbusClient(timeout);StateMachine.call(this,"init"),this.host="localhost",this.port=502,this.timeout=timeout||5e3,this.id=0,this._requests={},this._requestQueue=[];this.on("state_changed",function(oldState,newState){"error"===oldState&&"online"===newState&&this._sendPacket()}),this.on("error",function(){for(var i in this._pQueue)this._requestQueue[i].reject({errCode:"connectionError"})}),this._receiveListener=function(resp){for(var request,offset=0,data=resp.data;offset<data.byteLength;){var mbap=new DataView(data,offset+0,7),tid=mbap.getUint16(0),pdu=new DataView(data,offset+7,2),byte_count=pdu.getUint8(1);request=this._requests[tid],request?(clearTimeout(request.timeout),request.handleResponse(data,offset),delete this._requests[tid],offset+=9+byte_count):offset+=9+byte_count}},this._createNewId=function(){return this.id=(this.id+1)%1e4,this.id},this._sendPacket=function(request){if(arguments.length>0&&this._requestQueue.push(request),!this._isWaiting&&this.inState("online")&&0!==this._requestQueue.length){this._isWaiting=!0;var request=this._requestQueue.shift(),timeout=setTimeout(function(){return this.inState("error")?void request.reject({errCode:"error"}):(this.setState("error"),request.reject({errCode:"timeout"}),this.fire("error",[{errCode:"timeout"}]),void delete this._requests[request.id])}.bind(this),this.timeout);request.setTimeout(timeout),chrome.sockets.tcp.send(this.socketId,request.packet,function(sendInfo){return sendInfo.resultCode<0?(this.setState("error"),void(this._isWaiting=!1)):(this._isWaiting=!1,void this._sendPacket())}.bind(this))}},chrome.sockets.tcp.onReceive.addListener(this._receiveListener.bind(this))},ModbusClient.inherits(StateMachine),ModbusClient.method("readCoils",function(start,count){var request=new ReadCoilsRequest(this._createNewId(),start,count);return this.inState("online")?(this._requests[request.id]=request,this._sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())}),ModbusClient.method("readHoldingRegisters",function(start,count){var request=new ReadHoldingRegistersRequest(this._createNewId(),start,count);return this.inState("online")?(this._requests[request.id]=request,this._sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())}),ModbusClient.method("readInputRegisters",function(start,count){var request=new ReadInputRegistersRequest(this._createNewId(),start,count);return this.inState("online")?(this._requests[request.id]=request,this._sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())}),ModbusClient.method("writeSingleCoil",function(address,value){var request=new WriteSingleCoilRequest(this._createNewId(),address,value);return this.inState("online")?(this._requests[request.id]=request,this._sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())}),ModbusClient.method("writeSingleRegister",function(address,value){var request=new WriteSingleRegisterRequest(this._createNewId(),address,value);return this.inState("online")?(this._requests[request.id]=request,this._sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())}),ModbusClient.method("connect",function(host,port){this.host=host,this.port=port;var that=this,connect=function(){chrome.sockets.tcp.connect(that.socketId,that.host,that.port,function(result){return 0!==result?void that.fire("connect_error",{errCode:"connectionError",result:result}):(that.setState("online"),void that.fire("connected"))})};return this.socketId?connect():chrome.sockets.tcp.create({},function(createInfo){that.socketId=createInfo.socketId,chrome.sockets.tcp.onReceiveError.addListener(function(){that.setState("error"),that.fire("error")}),connect()}),this}),ModbusClient.method("disconnect",function(){var that=this;return chrome.sockets.tcp.disconnect(this.socketId,function(){that.setState("offline"),that.fire("disconnected")}),this}),ModbusClient.method("reconnect",function(){var that=this;chrome.sockets.tcp.setPaused(this.socketId,!1,function(){chrome.sockets.tcp.disconnect(that.socketId,function(){chrome.sockets.tcp.connect(that.socketId,that.host,that.port,function(res){return 0!==res&&that.inState("error")?void that.fire("error",[{errCode:"reconnectionFailed",result:res}]):0!==res&&that.inState("offline")?void that.fire("connect_error",[{errCode:"connectionError",result:res}]):(that.setState("online"),void that.fire("connected"))})})})});var RangeList=function(){return this instanceof RangeList?(this._list=[],void(this._shrink=function(){if(1===this._list.length)return this;for(var next,j=0;j<this._list.length-1;)cur=this._list[j],next=this._list[j+1],cur.end>=next.start-1?(cur.end=Math.max(cur.end,next.end),this._list.splice(j+1,1)):j+=1})):new RangeList};RangeList.method("merge",function(start,end){if(start>=end)return this;if(0===this._list.length)return this._list.push({start:start,end:end}),this;for(var i in this._list){if(cur=this._list[i],cur.start>end)return this._list.splice(i,0,{start:start,end:end}),this._shrink(),this;if(cur.start>=start&&cur.end>start){if(cur.end<end)return cur.start=start,cur.end=start+end,this._shrink(),this;if(cur.end>=end)return cur.start=start,cur.end=cur.end,this._shrink(),this}if(cur.start<start&&cur.end>start){if(cur.end>=end)return this._shrink(),this;if(cur.end<end)return cur.end=end,this._shrink(),this}}return this._list.push({start:start,end:end}),this._shrink(),this}),RangeList.method("getList",function(){return this._list}),ModbusLoop=function(client,duration){return this instanceof ModbusLoop?(StateMachine.call(this,"stop"),this._client=client,this._readInputRegisterList=new RangeList,this._readCoilList=new RangeList,this._inputRegisters=[],this._client.on("disconnected",function(){this.setState("stop")}.bind(this)),this._client.on("error",function(){this.setState("stop")}.bind(this)),this._updateInputRegisters=function(start,data){for(var i=0;i<data.length;i+=1)this._inputRegisters[start+i]=data[i]},void(this._executeLoop=function(){var cur,promise,inputsList,list=[];if(this.inState("running")){inputsList=this._readInputRegisterList.getList();for(var i=0;i<inputsList.length;i+=1)cur=inputsList[i],promise=this._client.readInputRegisters(cur.start,cur.end-cur.start),list.push(promise);$.when.apply(this,list).then(function(){var args;args=1===list.length?[arguments]:arguments;for(var i in args)this._updateInputRegisters(args[i][1].start,args[i][0]);this.fire("update",[this._inputRegisters]),this._executeLoop()}.bind(this)).fail(function(){this.setState("stop")}.bind(this))}})):new ModbusLoop(client,duration)},ModbusLoop.inherits(StateMachine),ModbusLoop.method("readInputRegisters",function(start,count){var defer=$.Deferred();return this._readInputRegisterList.merge(start,start+count),defer.promise()}),ModbusLoop.method("start",function(){this.setState("running"),this._executeLoop()}),ModbusLoop.method("stop",function(){this.setState("stop")});var ModbusServerClient=function(info,server,simDelay){if(!(this instanceof ModbusServerClient))return new ModbusServerClient(info,server,simDelay);this._info=info,this._client_socket_id=info.clientSocketId,this._server=server,this._simDelay=simDelay||0,this._queue=[],this._get_requests=function(data){for(var header,body,request,ret=[],offset=0;offset<data.byteLength;)header=new DataView(data,offset,7),request={header:{tid:header.getUint16(0),pid:header.getUint16(2),len:header.getUint16(4),uid:header.getUint8(6)}},offset+=7,body=new DataView(data,offset,request.header.len-1),request.body={fc:body.getUint8(0)},4===request.body.fc&&(request.body.adr=body.getUint16(1),request.body.cnt=body.getUint16(3)),6===request.body.fc&&(request.body.adr=body.getUint16(1),request.body.val=body.getUint16(3)),offset+=request.header.len-1,ret.push(request);return ret},this._handle_request=function(request){var ret_buffer,ret_head_dv,ret_body_dv;if(4===request.body.fc){ret_buffer=new ArrayBuffer(9+2*request.body.cnt),ret_head_dv=new DataView(ret_buffer,0,7),ret_head_dv.setUint16(0,request.header.tid),ret_head_dv.setUint16(2,request.header.pid),ret_head_dv.setUint16(4,3+2*request.body.cnt),ret_head_dv.setUint8(6,request.header.uid),ret_body_dv=new DataView(ret_buffer,7,2+2*request.body.cnt),ret_body_dv.setUint8(0,4),ret_body_dv.setUint8(1,2*request.body.cnt);for(var i=0;i<request.body.cnt;i+=1)ret_body_dv.setUint16(2+2*i,this._server.getInputRegister(request.body.adr+i));this._server.fire("read_input_registers",[request.body.adr,request.body.cnt])}return 6===request.body.fc&&(ret_buffer=new ArrayBuffer(12),ret_head_dv=new DataView(ret_buffer,0,7),ret_head_dv.setUint16(0,request.header.tid),ret_head_dv.setUint16(2,request.header.pid),ret_head_dv.setUint16(4,request.header.len),ret_head_dv.setUint8(6,request.header.uid),ret_body_dv=new DataView(ret_buffer,7,5),this._server.setInputRegister(request.body.adr,request.body.val),this._server.fire("write_single_register",[request.body.adr,request.body.val]),ret_body_dv.setUint8(0,6),ret_body_dv.setUint16(1,request.body.adr),ret_body_dv.setUint16(3,request.body.val)),ret_buffer},this._send_answer=function(buffer){var defer=$.Deferred();if(this._simDelay){var that=this;setTimeout(function(){chrome.sockets.tcp.send(that._client_socket_id,buffer,function(ret){return 0>ret?void defer.reject():void defer.resolve()})},this._simDelay)}else chrome.sockets.tcp.send(this._client_socket_id,buffer,function(ret){return 0>ret?void defer.reject():void defer.resolve()});return defer.promise()},this._handle_message=function(info){for(var requests=this._get_requests(info.data),send_q=[],ret=null,i=0;i<requests.length;i+=1)ret=this._handle_request(requests[i]),send_q.push(this._send_answer(ret));$.when(send_q).then(function(){}).fail(function(){})};chrome.sockets.tcp.setPaused(this._client_socket_id,!1,function(){}),chrome.sockets.tcp.onReceive.addListener(this._handle_message.bind(this))};ModbusServerClient.method("getInfo",function(){return this._client}),ServerRegister=function(start,server){return this instanceof ServerRegister?(Events.call(this),this._start=start,this._server=server,this._command={count:0,id:0,ex:!1},this._status={stateflag_1:0,stateflag_2:0,stateflag_3:0,stateflag_4:0,stateword:0,command_counter:0,command_ex:0,command_fail:0,arg:0},this._update_status=function(){var s=0;s+=this._status.stateflag_1?1:0,s+=this._status.stateflag_2?2:0,s+=this._status.stateflag_3?4:0,s+=this._status.stateflag_4?8:0,s+=this._status.stateword<<4,s+=this._status.command_counter<<11,s+=this._status.command_ex<<14,s+=this._status.command_fail<<15,this._server.setInputRegister(this._start,s),this._server.setInputRegister(this._start+1,this._status.arg)},this._evaluate=function(val){this._command.count=(7&val)>>0,this._command.id=(32760&val)>>3,this._command.ex=(32768&val)>>15,this._command.ex&&(this.fire("execute_"+this._command.id),this._status.command_counter=this._command.count,this._status.command_ex=1,this._update_status())},void this._server.on("write_single_register",function(start,val){start===this._start+2&&this._evaluate(val)}.bind(this))):new ServerRegister(start,server)},ServerRegister.inherits(Events),ModbusServer=function(host,port,simDelay){return this instanceof ModbusServer?(Events.call(this),this._host=host,this._port=port,this._simDelay=simDelay,this._socket_id=null,this._is_connected=!1,this._clients=[],this._input_register_offset=0,this._input_register=[],this._coils=[],void(this._create_new_client=function(info){var new_client=new ModbusServerClient(info,this,this._simDelay);this.fire("client_accepted",[new_client]),this._clients.push(new_client)})):new ModbusServer(host,port,simDelay)},ModbusServer.inherits(Events),ModbusServer.method("getClients",function(){return this._clients}),ModbusServer.method("start",function(){var defer=$.Deferred(),that=this;chrome.sockets.tcpServer.create(function(createInfo){that._socket_id=createInfo.socketId,chrome.sockets.tcpServer.listen(that._socket_id,that._host,that._port,function(res){return 0>res?(defer.reject({errCode:"notListening",result:res}),void chrome.sockets.tcpServer.close(that._socket_id,function(){})):(chrome.sockets.tcpServer.onAccept.addListener(that._create_new_client.bind(that)),void defer.resolve())})})}),ModbusServer.method("stop",function(){chrome.sockets.tcpServer.close(this._socket_id,function(){})}),ModbusServer.method("setInputRegisterOffset",function(offset){return this._input_register_offset=offset,this}),ModbusServer.method("setInputRegister",function(adr,value){return this._input_register[this._input_register_offset+adr]=value,this}),ModbusServer.method("getInputRegister",function(adr){return this._input_register[this._input_register_offset+adr]||(this._input_register[this._input_register_offset+adr]=0),this._input_register[this._input_register_offset+adr]}),ModbusServer.method("createNewRegister",function(start){return new ServerRegister(start,this)}),ModbusServer.method("createCustomRegister",function(cls,start){return new cls(start,this)}),Register=function(client,loop,start){return this instanceof Register?(StateMachine.call(this,"ready"),this._client=client,this._loop=loop,this._start=start,this.status={stateflag_1:!1,stateflag_2:!1,stateflag_3:!1,stateflag_4:!1,state:0,cmd_count:0,cmd_ex:!1,cmd_err:!1,arg:0},this._queue=[],this._cmd_id=0,this._loop.readInputRegisters(this._start,4),this._update_status=function(data){var status_reg=data[this._start],status_arg=data[this._start+1],s_1=1,s_2=2,s_3=4,s_4=8,s_state=2032,s_cid=14336,s_cide=16384,s_cidf=32768;this.status.stateflag_1=(status_reg&s_1)>>0,this.status.stateflag_2=(status_reg&s_2)>>1,this.status.stateflag_3=(status_reg&s_3)>>2,this.status.stateflag_4=(status_reg&s_4)>>3,this.status.state=(status_reg&s_state)>>4,this.status.cmd_count=(status_reg&s_cid)>>11,this.status.cmd_ex=(status_reg&s_cide)>>14,this.status.cmd_err=(status_reg&s_cidf)>>15,this.status.arg=status_arg,this.fire("update_status")},this._loop_listener_id=this._loop.on("update",this._update_status.bind(this)),this._execute=function(command,param){var defer=$.Deferred();return this._queue.push({deferred:defer,command:command,param:param}),this.inState("ready")&&this._flush(),defer.promise()},this.on("state_changed",function(oldState,newState){"ready"===newState&&this._flush()}),void(this._flush=function(){if(0!==this._queue.length&&!this.inState("execution")){this.setState("execution");var first=this._queue.shift(),command=first.command,defer=(first.param,first.deferred);this._cmd_id=(this._cmd_id+1)%8;var cmd=command<<3,ex_flag=32768,that=this;this.cmd_reg=this._cmd_id+cmd+ex_flag,this._client.writeSingleRegister(this._start+2,this.cmd_reg).fail(function(err){defer.reject({errCode:"modbusError"}),that.setState("ready")}).then(function(){var handler_id,timeout_id,update_count=0;timeout_id=setTimeout(function(){defer.reject({errCode:"timeout",update_count:update_count}),that.setState("ready")},5e3),handler_id=that.on("update_status",function(){update_count+=1,that.status.cmd_count===that._cmd_id&&that.status.cmd_ex&&(that.off(handler_id),clearTimeout(timeout_id),that.status.cmd_err?defer.reject({errCode:"plcError"}):defer.resolve(that.status.arg),that.setState("ready"))})})}})):new Register(client,loop,start)},Register.inherits(StateMachine),Register.method("close",function(){this._loop.off(this._loop_listener_id)})}();