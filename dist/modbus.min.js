!function(){!function(){Function.prototype.method=function(name,func){return this.prototype[name]=func,this},Function.method("inherits",function(superCtor){return this.super_=superCtor,this.prototype=Object.create(superCtor.prototype,{constructor:{value:this,enumerable:!1,writable:!0,configurable:!0}}),this});var Events=function(){if(!(this instanceof Events))return new Events;var cbList={};this.fire=function(name,args){if(cbList[name]){for(var i in cbList[name])cbList[name][i].apply(this,args);return this}},this.fireLater=function(name,args){return void 0===args&&(args=[]),function(){var aA=Array.protoype.slice.call(arguments,0),a=args.concat(aA);this.fire(name,a.length>0?a:void 0)}.bind(this)},this.on=function(name,func){return cbList.hasOwnProperty(name)||(cbList[name]=[]),cbList[name].push(func),{name:name,index:cbList[name].length-1}},this.off=function(id){return cbList[id.name].splice(id.index),this}},StateMachine=function(initState){if(!(this instanceof StateMachine))return new StateMachine(initState);Events.call(this);var state=initState;this.inState=function(newState){return state===newState},this.getState=function(){return state},this.setState=function(newState){var oldState=state;return state=newState,this.fire("state_changed",[oldState,newState]),this}};StateMachine.inherits(Events);var MBAP_TID=0,MBAP_PID=2,MBAP_LEN=4,MBAP_UID=6,BODY_FC=0,BODY_START=1,BODY_COUNT=3,READ_COILS=1,READ_HOLDING_REGISTERS=3,READ_INPUT_REGISTERS=4,WRITE_SINGLE_COIL=5,WRITE_SINGLE_REGISTER=6,WRITE_MULTIPLE_REGISTERS=16,ModbusRequest=function(id,length){if(!(this instanceof ModbusRequest))return new ModbusRequest(id,length);var deferred=$.Deferred(),packet=new ArrayBuffer(length),header=new DataView(packet,0,7),timeout=null,init=function(){header.setUint16(MBAP_TID,id),header.setUint16(MBAP_PID,0),header.setUint16(MBAP_LEN,length-6),header.setUint8(MBAP_UID,255)}.bind(this);this.getId=function(){return id},this.getPacket=function(){return packet},this.getPromise=function(){return deferred.promise()},this.reject=function(){return deferred.reject.apply(null,arguments),this},this.resolve=function(){return deferred.resolve.apply(null,arguments),this},this.getTimeout=function(){return timeout},this.setTimeout=function(to){return timeout=to,this},init()},ReadCoilsRequest=function(id,start,count){if(!(this instanceof ReadCoilsRequest))return new ReadCoilsRequest(id,start,count);ModbusRequest.call(this,id,12);var body,init=function(){body=new DataView(this.getPacket(),7,5),body.setUint8(BODY_FC,READ_COILS),body.setUint16(BODY_START,start),body.setUint16(BODY_COUNT,count)}.bind(this);this.getStart=function(){return start},this.getCount=function(){return count},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.reject({errCode:"serverError"}),2;var i,t,j,mask,dv=new DataView(data,offset+9,byte_count),fc_data=[],c=count;for(i=0;i<count;i+=1)for(t=dv.getUint8(i),j=0;j<7&&(mask=1<<j,fc_data.push(t&0!==mask),c-=1,0!==c);j+=1);return this.resolve(fc_data,this),byte_count+2},init()};ReadCoilsRequest.inherits(ModbusRequest);var ReadHoldingRegistersRequest=function(id,start,count){if(!(this instanceof ReadHoldingRegistersRequest))return new ReadHoldingRegistersRequest(id,start,count);ModbusRequest.call(this,id,12);var body,init=function(){body=new DataView(this.getPacket(),7,5),body.setUint8(BODY_FC,READ_HOLDING_REGISTERS),body.setUint16(BODY_START,start),body.setUint16(BODY_COUNT,count)}.bind(this);this.getStart=function(){return start},this.getCount=function(){return count},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.reject({errCode:"serverError"}),2;for(var dv=new DataView(data,offset+7+2,byte_count),fc_data=[],i=0;i<byte_count/2;i+=1)fc_data.push(dv.getUint16(2*i));return this.resolve(fc_data,this),byte_count+2},init()};ReadHoldingRegistersRequest.inherits(ModbusRequest);var ReadInputRegistersRequest=function(id,start,count){if(!(this instanceof ReadInputRegistersRequest))return new ReadInputRegistersRequest(id,start,count);ModbusRequest.call(this,id,12);var body,init=function(){body=new DataView(this.getPacket(),7,5),body.setUint8(BODY_FC,READ_INPUT_REGISTERS),body.setUint16(BODY_START,start),body.setUint16(BODY_COUNT,count)}.bind(this);this.getStart=function(){return start},this.getCount=function(){return count},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,2)),fc=pdu.getUint8(0),byte_count=pdu.getUint8(1);if(fc>128)return this.reject({errCode:"serverError"}),2;for(var dv=new DataView(data,offset+7+2,byte_count),fc_data=[],i=0;i<byte_count/2;i+=1)fc_data.push(dv.getUint16(2*i));return this.resolve(fc_data,this),byte_count+2},init()};ReadInputRegistersRequest.inherits(ModbusRequest);var WriteSingleCoilRequest=function(id,address,value){if(!(this instanceof WriteSingleCoilRequest))return new WriteSingleCoildRequest(id,address,value);ModbusRequest.call(this,id,12);var body,init=function(){body=new DataView(this.getPacket(),7,5),body.setUint8(BODY_FC,WRITE_SINGLE_COIL),body.setUint16(BODY_START,address),body.setUint16(BODY_COUNT,value?65280:0)}.bind(this);this.getAddress=function(){return address},this.getValue=function(){return value},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,5)),fc=pdu.getUint8(0);pdu.getUint8(1),pdu.getUint16(3);return fc>128?(this.reject({errCode:"serverError"}),2):(this.resolve(this),5)},init()};WriteSingleCoilRequest.inherits(ModbusRequest);var WriteSingleRegisterRequest=function(id,address,value){if(!(this instanceof WriteSingleRegisterRequest))return new WriteSingleRegisterRequest(id,address,value);ModbusRequest.call(this,id,12);var body,init=function(){body=new DataView(this.getPacket(),7,5),body.setUint8(BODY_FC,WRITE_SINGLE_REGISTER),body.setUint16(BODY_START,address),body.setUint16(BODY_COUNT,value)}.bind(this);this.getAddress=function(){return address},this.getValue=function(){return value},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,5)),fc=pdu.getUint8(0);pdu.getUint16(1),pdu.getUint16(3);return fc>128?(this.reject({errCode:"serverError"}),2):(this.resolve(this),5)},init()};WriteSingleRegisterRequest.inherits(ModbusRequest);var WriteMultipleRegistersRequest=function(id,address,values){if(!(this instanceof WriteMultipleRegistersRequest))return new WriteMultipleRegistersRequest(id,address,values);ModbusRequest.call(this,id,13+2*values.length);var body,init=function(){body=new DataView(this.getPacket(),7,6+2*values.length),body.setUint8(BODY_FC,WRITE_MULTIPLE_REGISTERS),body.setUint16(1,address),body.setUint16(3,values.length),body.setUint8(5,2*values.length),values.forEach(function(v,i){body.setUint16(6+2*i,v)})}.bind(this);this.getAddress=function(){return address},this.getValues=function(){return values},this.handleResponse=function(data,offset){var pdu=(new DataView(data,offset,7),new DataView(data,offset+7,5)),fc=pdu.getUint8(0);pdu.getUint16(1),pdu.getUint16(3);return fc>128?(this.reject({errCode:"serverError"}),2):(this.resolve(this),5)},init()};WriteMultipleRegistersRequest.inherits(ModbusRequest);var ModbusRequestManager=function(){if(!(this instanceof ModbusRequestManager))return new ModbusRequestManager;StateMachine.call(this,"ready");var queue=[],currentRequest=null,socketId=null,receiveBuffer=[],init=function(){chrome.sockets.tcp.onReceive.addListener(receiveListener),this.on("state_changed",function(oldState,newState){"ready"===newState&&send()}.bind(this))}.bind(this),receiveListener=function(info){if(info.socketId===socketId){if(!this.inState("waiting"))throw new Error('ModbusRequestManager - Received Packet while in state "waiting".');receiveBuffer.push(info),handleResponse()}}.bind(this),handleResponse=function(){if(null!==receiveBuffer.length){var response=receiveBuffer.shift(),data=response.data;if(!(data.byteLength<7)){var mbap=new DataView(data,0,7),tid=mbap.getUint16(0);currentRequest&&currentRequest.getId()===tid&&(clearTimeout(currentRequest.getTimeout()),currentRequest.handleResponse(data,0),this.setState("ready"))}}}.bind(this),send=function(){if(0!==queue.length){this.setState("sending"),currentRequest=queue.shift();var timeout_no=setTimeout(function(){currentRequest.reject({errCode:"timeout"}),this.fire("error",[{errCode:"timeout"}])}.bind(this),5e3);currentRequest.setTimeout(timeout_no),chrome.sockets.tcp.send(socketId,currentRequest.getPacket(),function(sendInfo){return sendInfo.resultCode<0?(currentRequest.reject({errCode:"sendError"}),void this.setState("ready")):void this.setState("waiting")}.bind(this))}}.bind(this);this.setSocketId=function(id){return socketId=id,this},this.sendPacket=function(packet){if(queue.push(packet),null===socketId)throw new Error("ModbusRequestManager - No socketId provided.");if(this.inState("ready"))return send(),this},this.clear=function(){for(;queue.length>0;)queue.pop().reject({errCode:"clientOffline"});this.setState("ready")},this.flush=function(){if(null!==socketId)return send(),this},init()};ModbusRequestManager.inherits(StateMachine),ModbusClient=function(timeout,autoreconnect){if(!(this instanceof ModbusClient))return new ModbusClient(timeout,autoreconnect);StateMachine.call(this,"init");var socketId,host="localhost",port=502,id=0,requestManager=new ModbusRequestManager,isReconnecting=!1,init=function(){timeout||(timeout=5e3),requestManager.on("error",function(err){this.inState("offline")||(this.fire("error",[err]),autoreconnect?this.reconnect():this.disconnect())}.bind(this)),this.on("state_changed",function(oldState,newState){this.fire(newState),"error"===oldState&&"online"===newState&&requestManager.flush()}.bind(this)),this.on("offline",function(){requestManager.clear()}.bind(this)),this.on("online",function(){isReconnecting=!1}.bind(this)),this.on("error",function(){isReconnecting=!1}.bind(this)),createSocket()}.bind(this),onReceiveError=function(info){if(info.socketId===socketId)return this.setState("offline"),this.fire("error",[{errCode:"ServerError",args:arguments}]),autoreconnect?void this.reconnect():void this.close()}.bind(this),createSocket=function(){chrome.sockets.tcp.onReceiveError.addListener(onReceiveError),chrome.sockets.tcp.create({},function(createInfo){socketId=createInfo.socketId,requestManager.setSocketId(socketId),this.setState("offline"),this.fire("ready")}.bind(this))}.bind(this),createNewId=function(){return id=(id+1)%1e4}.bind(this),sendPacket=function(req){this.inState("online")&&requestManager.sendPacket(req)}.bind(this);this.isOnline=function(){return this.inState("online")}.bind(this),this.readCoils=function(start,count){var request=new ReadCoilsRequest(createNewId(),start,count);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())},this.readHoldingRegisters=function(start,count){var request=new ReadHoldingRegistersRequest(createNewId(),start,count);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())},this.readInputRegisters=function(start,count){var request=new ReadInputRegistersRequest(createNewId(),start,count);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())},this.writeSingleCoil=function(address,value){var request=new WriteSingleCoilRequest(createNewId(),address,value);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())},this.writeSingleRegister=function(address,value){var request=new WriteSingleRegisterRequest(createNewId(),address,value);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())},this.writeMultipleRegisters=function(address,values){var request=new WriteMultipleRegistersRequest(createNewId(),address,values);return this.inState("online")?(sendPacket(request),request.getPromise()):(request.reject({errCode:"offline"}),request.getPromise())};var connect=function(){if(!this.inState("connecting")&&!this.inState("online"))return this.setState("connecting"),this.fire("busy"),chrome.sockets.tcp.connect(socketId,host,port,function(result){return 0!==result?(this.fire("error",[{errCode:"connectionError",result:result}]),void(autoreconnect&&this.reconnect(5e3))):void this.setState("online")}.bind(this)),this}.bind(this);this.setHost=function(h){return host=h,this},this.setPort=function(p){return port=p,this},this.getHost=function(){return host},this.getPort=function(){return port},this.connect=function(){return connect(),this},this.disconnect=function(cb){if(!this.inState("disconnecting"))return this.setState("disconnecting"),this.fire("busy"),chrome.sockets.tcp.disconnect(socketId,function(){this.setState("offline"),cb&&cb()}.bind(this)),this},this.close=function(cb){this.disconnect(function(){chrome.sockets.tcp.close(socketId,function(){this.setState("init"),socketId=null,!cb}.bind(this))}.bind(this))};var reconnect=function(){return this.inState("offline")?void connect():void chrome.sockets.tcp.disconnect(socketId,function(){this.setState("offline"),connect()}.bind(this))}.bind(this);this.reconnect=function(wait){isReconnecting||(isReconnecting=!0,this.fire("reconnecting"),setTimeout(function(){reconnect()}.bind(this),wait?wait:0))},init()},ModbusClient.inherits(StateMachine);var RangeList=function(max){if(!(this instanceof RangeList))return new RangeList(max);var list=[],shrink=function(){if(1===list.length)return optimize(),this;for(var next,j=0;j<list.length-1;)cur=list[j],next=list[j+1],cur.end>=next.start-1?(cur.end=Math.max(cur.end,next.end),list.splice(j+1,1)):j+=1;optimize()}.bind(this);this.merge=function(start,end){if(end<=start)return this;if(0===list.length)return list.push({start:start,end:end}),this;for(var i in list){if(cur=list[i],cur.start>end)return list.splice(i,0,{start:start,end:end}),shrink(),this;if(cur.start>=start&&cur.end>start){if(cur.end<end)return cur.start=start,cur.end=start+end,shrink(),this;if(cur.end>=end)return cur.start=start,cur.end=cur.end,shrink(),this}if(cur.start<start&&cur.end>start){if(cur.end>=end)return shrink(),this;if(cur.end<end)return cur.end=end,shrink(),this}}return list.push({start:start,end:end}),shrink(),this};var optimize=function(){if(max)for(var i=0;i<list.length;i+=1)list[i].end-list[i].start>max&&(list.splice(i+1,0,{start:list[i].start+max,end:list[i].end}),list[i].end=list[i].start+max)}.bind(this);this.getList=function(){return list}};"undefined"!=typeof exports&&(exports.RangeList=RangeList),ModbusLoop=function(client,duration){if(!(this instanceof ModbusLoop))return new ModbusLoop(client,duration);StateMachine.call(this,"stop");var startTime,endTime,midTime,readInputRegistersList=new RangeList(125),readHoldingRegistersList=new RangeList(125),inputRegisters=(new RangeList(125),[]),holdingRegisters=[],lastTime=0,init=function(){this.on("state_changed",function(oldState,newState){"start"===newState&&this.fire(newState),"stop"===newState&&this.fire(newState)}.bind(this)),client.on("disconnected",function(){this.setState("stop")}.bind(this)),client.on("error",function(){this.setState("stop")}.bind(this))}.bind(this),updateInputRegisters=function(start,data){for(var i=0;i<data.length;i+=1)inputRegisters[start+i]=data[i]}.bind(this),updateHoldingRegisters=function(start,data){for(var i=0;i<data.length;i+=1)holdingRegisters[start+i]=data[i]}.bind(this),executeInputRegistersLoop=function(){var cur,promise,inputsList,retPromise,promisses=[];inputsList=readInputRegistersList.getList();for(var i=0;i<inputsList.length;i+=1)cur=inputsList[i],promise=client.readInputRegisters(cur.start,cur.end-cur.start),promisses.push(promise);return retPromise=$.when.apply(this,promisses).then(function(){var args;args=1===promisses.length?[arguments]:arguments;for(var i=0;i<args.length;i+=1)args[i]&&updateInputRegisters(args[i][1].getStart(),args[i][0])}.bind(this))}.bind(this),executeHoldingRegistersLoop=function(){var cur,promise,inputsList,retPromise,promisses=[];inputsList=readHoldingRegistersList.getList();for(var i=0;i<inputsList.length;i+=1)cur=inputsList[i],promise=client.readHoldingRegisters(cur.start,cur.end-cur.start),promisses.push(promise);return retPromise=$.when.apply(this,promisses).then(function(){var args;args=1===promisses.length?[arguments]:arguments;for(var i=0;i<args.length;i+=1)updateHoldingRegisters(args[i][1].getStart(),args[i][0])}.bind(this))}.bind(this),executeLoop=function(){if(this.inState("running")){startTime=(new Date).getTime();var len_1=readInputRegistersList.getList().length,len_2=readHoldingRegistersList.getList().length,len=len_1+len_2;if(0===len)return void setTimeout(executeLoop.bind(this),1e3);var loop_1=executeInputRegistersLoop(),loop_2=executeHoldingRegistersLoop();$.when.apply(this,[loop_1,loop_2]).then(function(){endTime=(new Date).getTime(),midTime=(lastTime+(endTime-startTime))/2,lastTime=midTime,this.fire("update",[inputRegisters,holdingRegisters,{startTime:startTime,endTime:endTime,midTime:midTime,requestCount:readHoldingRegistersList.getList().length+readInputRegistersList.getList().length,holdingRequests:readHoldingRegistersList.getList(),inputRequests:readInputRegistersList.getList()}]),executeLoop()}.bind(this)).fail(function(){executeLoop()}.bind(this))}}.bind(this);this.readInputRegisters=function(start,count){return readInputRegistersList.merge(start,start+count),this},this.readHoldingRegisters=function(start,count){return readHoldingRegistersList.merge(start,start+count),this},this.start=function(){(this.inState("stop")||this.inState("init"))&&(this.setState("running"),executeLoop())},this.stop=function(){this.setState("stop")},init()},ModbusLoop.inherits(StateMachine);var register_debug_id=0;Register=function(client,loop,start){if(!(this instanceof Register))return new Register(client,loop,start);StateMachine.call(this,"init");var loopListenerId,status=(register_debug_id++,{stateflag_1:!1,stateflag_2:!1,stateflag_3:!1,stateflag_4:!1,state:0,cmd_count:0,cmd_ex:!1,cmd_err:!1,arg:0}),queue=[],cmdId=0;loop.readHoldingRegisters(start,4);var updateStatus=function(inputRegisters,holdingRegisters){var status_reg=holdingRegisters[start],status_arg=holdingRegisters[start+1],s_1=1,s_2=2,s_3=4,s_4=8,s_state=2032,s_cid=14336,s_cide=16384,s_cidf=32768;status.stateflag_1=(status_reg&s_1)>>0,status.stateflag_2=(status_reg&s_2)>>1,status.stateflag_3=(status_reg&s_3)>>2,status.stateflag_4=(status_reg&s_4)>>3,status.state=(status_reg&s_state)>>4,status.cmd_count=(status_reg&s_cid)>>11,status.cmd_ex=(status_reg&s_cide)>>14,status.cmd_err=(status_reg&s_cidf)>>15,status.arg=status_arg,this.inState("init")&&(cmdId=status.cmd_count,this.setState("ready")),this.fire("update_status",[status])}.bind(this),flush=function(){if(0!==queue.length&&this.inState("ready")){this.setState("execution");var first=queue.shift(),command=first.command,defer=first.deferred;cmdId=(cmdId+1)%8;var cmd=command<<3,ex_flag=32768,cmdReg=cmdId+cmd+ex_flag,promisses=[];void 0!==first.param&&promisses.push(client.writeSingleRegister(start+3,first.param)),promisses.push(client.writeSingleRegister(start+2,cmdReg)),$.when.apply(this,promisses).fail(function(err){defer.reject({errCode:"modbusError"}),this.setState("ready")}.bind(this)).then(function(){var handler_id,timeout_id,update_count=0;timeout_id=setTimeout(function(){defer.reject({errCode:"timeout",update_count:update_count}),this.setState("ready")}.bind(this),5e3),handler_id=this.on("update_status",function(status){update_count+=1,status.cmd_count===cmdId&&status.cmd_ex&&(this.off(handler_id),clearTimeout(timeout_id),status.cmd_err?defer.reject({errCode:"plcError"}):defer.resolve(status.arg),this.setState("ready"))}.bind(this))}.bind(this))}}.bind(this);loopListenerId=loop.on("update",updateStatus),this.execute=function(command,param){var defer=$.Deferred();return queue.push({deferred:defer,command:command,param:param}),flush(),defer.promise()},this.on("state_changed",function(oldState,newState){"ready"===newState&&flush()}),this.getStatus=function(){return status},this.getAddress=function(){return start},this.close=function(){return loop.off(loopListenerId),this}},Register.inherits(StateMachine)}()}();